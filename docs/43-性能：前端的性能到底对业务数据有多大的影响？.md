### 前端的性能

#### 总论
性能优化不能只着眼于局部的代码。**一切没有profiling的性能都是耍流氓。凡是真正有价值的性能优化，必定是从端到端的业务场景建立体系来考虑的。**
性能体系的建立可以分成以下几部分：
* 现状评估和建立指标
* 技术方案
* 执行
* 结果评估和监控

##### 现状评估和建立指标
作为一个工程师，指标又要考虑两个因素。一方面，对用户来说，什么样的性能指标能更好地评估它的体验？另一方面，对公司来说，什么样的指标会影响业务价值呢？
性能问题可以分成很多方面，最重要的几个点是：
* 页面加载性能
* 动画与操作性能
* 内存、电量消耗

注意，这里我们仅仅是对“性能”两个字的分析和解读，在对大量的用户数据分析后，我们发现，其实这三部分中，“页面加载性能”跟用户的流失率有非常强的关联性，而用户流失率，正是公司业务非常看重的指标。
秒开率，即一秒之内打开的用户占用户总量的百分比。

##### 技术方案
首先我们要简单分析一下，从输入URL后按下回车，到底发生了什么。
* 从域名到IP地址，需要用DNS协议查询；
* HTTP协议是用TCP传输的，所以会有TCP建立连接过程；
* 如果使用HTTPS，还有有HTTPS交换证书；
* 每个网页还有图片等请求。

从这个分析和实际试验的结果看，网页的加载时间，不但跟体积有关系，还跟请求数有很大关系，因此，我们最终设计的技术方案大约可以这样划分：
![avatar](https://static001.geekbang.org/resource/image/6b/f2/6b5051c452af8c3db5fbb8ba6b9e34f2.jpg)
这里仅仅列出了性能优化的一部分技术方案，是我认为比较重要的部分，可以看到，这里涉及的并不仅仅是前端技术，有服务端、客户端、设计师团队，所以要想做好性能优化，绝对不能把自己限制在局部的视角，必须是整个业务一起考虑，才能有良好的收效。

##### 执行
了技术方案，我们只完成了一半的工作，接下来我们还需要一个执行过程。
执行也不简单，如果说方案主要靠技术，那么执行就是靠工程实施了。
工程水平从低到高分成三个阶段：
* 纯管理
* 制度化
* 自动化
制度化执行方式是用规则代替人的命令，指定责任人，通过培训、checklist、定期review等具体措施来保证实施。制度化执行可以极大地减轻管理工作量，一般现代互联网公司都会采用类似的方式。但是制度化执行方式还有很大成分是依靠人的主动性的，对程序员来说，还有更好的方式：自动化。
自动化的方式是在一些重要的操作路径上设置规则，针对我们的性能优化，有两个点适合做这件事：一个是把开发好的页面发布上线，另一个是开发好的页面URL投放到首页等处的链接。

#### 结果评估和监控
要想做线上监控，分两个部分：
* 数据采集
* 数据展现

数据采集部分，同样需要发布平台或者开发工具来配合，对性能数据来说，Performance API非常好用，它是浏览器记录的性能数据，一般来说，我们用统一的代码把它上传到服务器端就够用了。
数据的展现部分就比较自由了，可以用不同的数据可视化方案来展现性能数据，没有一定之规。一般的数据监控平台，会提供报警机制，对性能来说，报警需求不是特别强烈，但是也可以设置一些条件，针对秒开率特别低的网页报警。

